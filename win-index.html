<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Take picture</title>
    <link rel="stylesheet" href="win-css/bootstrap.min.css">
    <script src="win-js/jquery-3.1.1.min.js"></script>
    <style>
        body,html {
            display:flex;
  align-items:center;
  height: 100%;
  width: 100%;
        }
    </style>
</head>
<body>
        <div class="container-fluid mh-100 ">
                <div class="row"   id="uploading-msg" style="margin: 30px; display: none;">
                    <div class="col-md-12" >
                      <p>Uploading...</p>
                    </div>
                </div>
                <div class="row"  id="picture-url-div" style="margin: 30px; display: none;" >
                    <div class="col-md-12" >
                        <button id="gallery" class="btn btn-primary align-middle " style="height: 100%;" >Gallery</button>

                        <!-- Target -->
                        <input readonly style="width:85%; height: 100%; "  type="url" name="picture-url" id="picture-url" value="">
            
                        <!-- Trigger -->
                        <button style="margin-left: 0;" class="btn-copy" data-clipboard-target="#picture-url">
                            <img src="win-assets/clippy.svg" width="48" height="48" alt="Copy to clipboard">
                        </button>

                    </div>
                </div>
              <div class="row">
                <div class="col-md-6 col-lg-6  align-self-center" >
                    <div class="card" >
                        <video id="player"  class="card-img-top"   autoplay></video>
                        <div class="card-body">
                          <div class="text-left" >
                            <!-- <select name="cameras" id="cameraSelect">
                                <option value="0">Choose camera</option>
                            </select> -->
                            <!-- <button  id="change-camera">
                                <img src="assets/switch_camera.svg" width="32" height="32" alt="">
                            </button> -->
                            <a href="#" id="capture" class="btn btn-primary">Take picture</a>
                          </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6  col-lg-6 align-self-center invisible" id="captured-image" >
                    <div class="card" >
                        <img id="picture-captured" class="card-img-top"    src="" alt="">
                        <!-- <canvas id="snapshot" class="card-img-top" width=640 height=480 ></canvas> -->
                        <div class="card-body">
                                <div class="text-right" >
                                    <a href="#" id="upload" class="btn btn-primary">Upload</a>
                                </div>
                        </div>
                      </div>
                </div>
              </div>
            </div>
    
    
    
    


    <script>
        loadCamera();

        // //load video camera
        function loadCamera() {
            // front = !front; 
            // const constraints = { video: { facingMode: { exact: 'environment' } } };
            const constraints = { video: true };
            navigator.mediaDevices.getUserMedia(constraints)
            .then(gotMedia)
            .catch(error => console.error('getUserMedia() error:' + error));
        }

        function gotMedia(mediaStream) {

            //set vide source to player
            const player = document.getElementById('player');
            player.srcObject=mediaStream;
            // console.log(mediaStream.getVideoTracks());

            currentStream = mediaStream;
            const mediaStreamTrack = mediaStream.getVideoTracks()[0];  

            const constraints = {
                width: 1280,
                height: 720,
                aspectRatio: 1.7777777778
            };
            mediaStreamTrack.applyConstraints(constraints)
            .then(() => {
                // var settings = mediaStreamTrack.getSettings();
                const imageCapture = new ImageCapture(mediaStreamTrack);

                const captureButton = document.getElementById('capture');
                captureButton.addEventListener('click', function(){
                    takePic(imageCapture);
                })
                // console.log(settings)      
                // Do something with the track such as using the Image Capture API.
            })
            .catch(error => {
                console.error('applyConstraints() error:' + error);
                // The constraints could not be satisfied by the available devices.
            })
            
                    ;
            
        }

 



        var fd = new FormData();
    
        //take picture
        function takePic(imageCapture) {
            const player = document.getElementById('player');
                
            const img = document.getElementById('picture-captured');
            const capturedImage = document.getElementById('captured-image');
            var maxWidth;
            var maxHeight;
            imageCapture.getPhotoCapabilities()
            .then(photoCapabilities =>{
                // maxWidth = photoCapabilities.imageWidth.max;
                // maxHeight = photoCapabilities.imageHeight.max;
                maxWidth = 1088; // 3264 / 3
                maxHeight = 612; // 1836 / 3
            })
            .catch(error => console.error('getPhotoCapabilities() error:', error));

            imageCapture.takePhoto({ imageWidth:maxWidth, imageHeight: maxHeight })
            .then(blob => {
                
                fd.append('data', blob);
                fd.append('fname', 'image.png');

                img.src = URL.createObjectURL(blob);
                capturedImage.setAttribute('class',"col-md-6  col-lg-6 align-self-center visible");
                img.onload = () => { URL.revokeObjectURL(this.src); }
            })
            .catch(error => console.error('takePhoto() error:', error));
        }

        function stopVideoStream(mediaStream){
            if (mediaStream.active){
                mediaStream.getVideoTracks()[0].stop();
            }
        }

    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>

<script>
    var galleryButton = document.getElementById('gallery');
    galleryButton.addEventListener('click', function() {
        window.location.href = 'win-gallery.php';
    })

    $(document).ready(function(){
        var urls = '';
        var counter = 0;

        var img = document.getElementById('picture-captured');
        $("#upload").on("click", function() {
            $("#uploading-msg").show();

            $.ajax({
                type: "POST",
                url: "win-handlePictureUpload.php",
                data: fd,
                processData: false,
                contentType: false //data needs be read as FILES on the server
            }).done(function(response){
                    $("#uploading-msg").hide();
                    $("#picture-url-div").show();
                    //controls resetting the five image string
                    if (counter >= 5 ){
                        // console.log('Clicks reseted to 0');
                        counter = 0;
                        urls = '';
                    }
                
                    counter = counter + 1;
                    // adds vertical bar to the urls string
                    if (counter > 0 && counter <= 5 ){
                        urls = urls.concat(response + '|');   
                        // console.log(urls);
                    }
                    $("#picture-url").val(urls.slice(0, urls.length - 1));
                });
            });
    });
</script>

<script>
    $('.btn-copy').tooltip({
        trigger: 'click',
        placement: 'bottom'
    });
    
    function setTooltip(message) {
        $('.btn-copy').tooltip('hide')
        .attr('data-original-title', message)
        .tooltip('show');
    }
    
    function hideTooltip() {
        setTimeout(function() {
        $('.btn-copy').tooltip('hide');
        }, 1000);
    }
    
    var clipboard = new ClipboardJS('.btn-copy');
    
    clipboard.on('success', function(e) {
        setTooltip('Copied!');
        hideTooltip();
    
        e.clearSelection();
    });
    
    clipboard.on('error', function(e) {
        setTooltip('Failed!');
        hideTooltip();
    });
    
    </script>

</body>
</html>